<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Test</title>
    <script type="text/javascript">//https://stackoverflow.com/a/8567149
    function loadXMLDoc(url, method, data, callback) {
        var xmlhttp = new XMLHttpRequest();

        xmlhttp.onreadystatechange = function () {
            if (xmlhttp.readyState == XMLHttpRequest.DONE) {   // XMLHttpRequest.DONE == 4
                if ([200, 204].some(x => xmlhttp.status == x)) {
                    console.log(url, xmlhttp.status, xmlhttp.responseText)
                    callback(xmlhttp.responseText);
                } else if (xmlhttp.status == 400) {
                    console.log('There was an error 400');
                } else {
                    console.log('something else other than 200 was returned: ' + xmlhttp.status);
                }
            }
        };

        xmlhttp.open(method || "GET", url, true);
        if (data) {
            xmlhttp.send(JSON.stringify(data));
        } else {
            xmlhttp.send();
        }

    }

    function get(url, method, callback) {
        loadXMLDoc(url, method || "GET", null, function (data) {
            if (callback) {
                callback(data && data !== '' && JSON.parse(data));
            }
        });
    }

    const onLoad = function () {
        const dataUrl = (
            'http://localhost:8001/api/data'
            //'/api/data'
        );
        get(dataUrl, 'GET', renderMain);
        //renderMain();
    }

    var data, rendered, productsHashMap={};
    const productSortValues = {
        "picture":function (item) {return item["picture"];},
        "name":function (item) {return item["name"];},
        "value":function (item) {return item["value"];},
        "timestamp":function (item) {return item["timestamp"];},
        "merchant_name":function (item) {return item["merchant_name"];},
        "reviews_length":function (item) {return item["reviews"].length;},
    };

    function showRenderedProducts(header = true) {
        var productsDiv = document.getElementById("products");
        // https://stackoverflow.com/a/683429
        while (
            //productsDiv.hasChildNodes()
            productsDiv.childNodes.length > 1
            ) {
            productsDiv.removeChild(productsDiv.lastChild);
        }

        if (header) {
            productsDiv.appendChild(renderProductsHeader());
        }
        rendered.forEach(function (renderedItem) {
            productsDiv.appendChild(renderedItem);
        });
        attachProductHeaderClicks();
    }

    function renderMain(data) {
        window.data = data;
        data.forEach(function (item) {
            productsHashMap[item["id"]] = item;
        })
        rendered = renderData(data);
        showRenderedProducts();
        attachTabClicks();
    }

    function timestampToReadable(timestamp) {
        var date = new Date(timestamp * 1000);
        const pad = function (n) {
            return (n.toString()).padStart(2, "0");
        };
        return pad(date.getDate()) + "." +
            pad(date.getMonth() + 1) + "." +
            date.getFullYear().toString() + " " +
            pad(date.getHours()) + ":" +
            pad(date.getMinutes()) + ":" +
            pad(date.getSeconds());
    }

    const productFields = {
        "picture":[1,function (item) {
            return {"tag":"img","src":item["picture"],"class":"_40x40"};
        },"","Image"],
        "name":[6,function (item) {
            return {
                "tag": "a", "href": "javascript:showProduct('"+item["id"]+"')",
                "children": [item["name"]]
            };
        },"border-start","Name"],
        // "value":[1,function (item) {
        //     return "$"+item["value"];
        // }],
        "value":[1,function (item) {
            return "$"+item["value"].toFixed(2);
        },"border-start","Price"],
        "timestamp":[1,function (item) {
            return timestampToReadable(item["timestamp"]);
        },"border-start","Date add"],
        "merchant_name":[2,function (item) {
            return item["merchant_name"];
        },"border-start text-break","Name add"],
        "reviews_length":[1,function (item) {
            return item["reviews"].length.toString();
        },"border-start","#Reviews"],
    };

    function renderProductsOrReviews(fields) {
        return function (
            rowStyleAdd, rowIdF, colStyleAdd, childF,
            colIdF = function (field) {return "";}) {
            return function (item) {
                return {
                    "tag": "div", "class": "row border" + rowStyleAdd, "id": rowIdF(item),
                    "children": Object.keys(fields).map(
                        function (field) {
                            var f = fields[field];
                            var res = {
                                "tag": "div", "class": (f[2] + (f[2] === "" ? "" : " ") + "col-" + f[0]) +
                                    colStyleAdd,
                                "children": [
                                    childF(f, item)
                                ]
                            };
                            var colId = colIdF(field);
                            if (colId !== "") {
                                res["id"] = colId;
                            }
                            return res;
                        }
                    )
                }
            };
        }
    }

    var renderProductsInner = renderProductsOrReviews(productFields);

    function renderData(data,renderFunction=renderProductsInner) {
        const rowStyleAdd = " border-top-0",
            idF = function (item) {return item["id"];},
            colStyleAdd = "",
            childF = function(f,item) {return f[1](item);};
        // [ "name", "picture", "value", "`timestamp`", "merchant_name", "id", "reviews" ]
        return render(data.map(
            renderFunction(rowStyleAdd, idF, colStyleAdd, childF)
        ));
    }

    function renderProductsHeader() {
        return render(
            renderProductsInner(
                "",function (item) {return "products_header";},
                " fw-bold text-center",function (f,item) {return f[3];},
                function (field) {return "products_header_"+field;}
            )()
        );
    }

    function renderReviewsHeader() {
        return render(
            renderReviewsInner(
                "",function (item) {return "reviews_header";},
                " fw-bold text-center",function (f,item) {return f[3];}//,
                //function (field) {return "products_header_"+field;}
            )()
        );
    }

    function sortProductsInner(key, asc = 1) {
        rendered.sort(function (a,b) {
            var aValue = productSortValues[key](productsHashMap[a.id]),
                bValue = productSortValues[key](productsHashMap[b.id]);
            return asc * (aValue < bValue ? -1 : aValue > bValue ? 1 : 0);
        });
        showRenderedProducts(false);
    }

    var sortingProducts = ["",1];

    function sortProducts(key) {
        //console.log("sortProducts",key);
        if (sortingProducts[0]!==key) {
            sortingProducts = [key,1];
        } else {
            sortingProducts[1]*=-1;
        }
        const arrows = {"1":"&#8593;","-1":"&#8595;"};
        Object.keys(productSortValues).forEach(function (field) {
            document.getElementById("products_header_"+field)
            .innerHTML = productFields[field][3]+(
                field !== key?"":arrows[sortingProducts[1]]
            );
        });
        //var headerColDiv = document.getElementById("products_header_"+key);
        sortProductsInner(...sortingProducts);
    }

    function sortProductsClick(event) {
        var field = event.target.id.slice("products_header_".length);
        //console.log("sortProductsClick",field);
        sortProducts(field);
    }

    function attachProductHeaderClicks() {
        Object.keys(productSortValues).forEach(function (field) {
            document.getElementById("products_header_"+field).addEventListener(
                "click",sortProductsClick
            );
        });
    }

    function tabClick(event) {
        var tabKey = event.target.id.slice(0,-4);
        //console.log("tabClick",tabKey);
        showTab(tabKey);
    }

    function attachTabClicks() {
        ["products","reviews"].forEach(function (tabKey) {
            document.getElementById(tabKey+"_tab").addEventListener(
                "click",tabClick
            );
        });
    }

    const reviewFields = {
        'user_name':[2,function (item) {
            return item["user_name"];
        },"","User name"],
        'rating':[1,function (item) {
            return item["rating"].toString();
        },"border-start","Rating"],
        'comment':[8,function (item) {
            return item["comment"];
        },"border-start","Comment"],
        'timestamp':[1,function (item) {
            return timestampToReadable(item["timestamp"]);
        },"border-start","Time"],
    };

    var renderReviewsInner = renderProductsOrReviews(reviewFields);

    function renderReviews(reviews) {
        return renderData(reviews,
            //renderProductsOrReviews(reviewFields)
            renderReviewsInner
        )
    }

    function renderProduct(id) {
        var reviewsCount = 0, reviewsSum = 0;
        productsHashMap[id]["reviews"].forEach(function (item){
            reviewsCount += 1;
            reviewsSum += item["rating"];
        });
        return {
            "tag": "div", "class": "row", "children": [
                {
                    "tag": "div", "class": "col-auto", "children": [
                        {"tag": "img", "src": productsHashMap[id]["picture"]}
                    ]
                },
                {
                    "tag": "div", "class": "col", "children": [
                        {
                            "tag": "div", "class": "row", "children": [
                                {
                                    "tag": "div", "class": "col-auto", "children": [
                                        renderStars(reviewsCount===0?0:Math.floor(reviewsSum/reviewsCount))
                                    ]
                                },
                                {
                                    "tag": "div", "class": "col-auto", "children": [
                                        "("+(
                                            reviewsCount===0?"No reviews":
                                                (reviewsSum/reviewsCount).toFixed(3)
                                        )+")"
                                    ]
                                }
                            ]
                        },
                        {
                            "tag": "div", "class": "row", "children": [
                                {
                                    "tag": "div", "class": "col-auto", "children": [
                                        productsHashMap[id]["name"]
                                    ]
                                },

                            ]
                        },
                    ]
                },
            ]
        };
    }

    function starSVG(odd,rated) {
        // the entire svg and styles were taken as is from movielens.org
        return {
        "tag":"svg", "class":"star", "viewBox":"0 0 24 24", "xmlns":"http://www.w3.org/2000/svg",
             "style": "width: 24px; height: 24px; margin-left: "+(odd?"0":"-12")+"px;",
                 "children": [
                     {"tag":"path", "class":"star-shape"+(rated?" rated":""),
                         "xmlns":"http://www.w3.org/2000/svg",
                         "d":"M12 .587l3.668 7.568 8.332 1.151-6.064 5.828 1.48 8.279-7.416-3.967-7.417 3.967 1.481-8.279-6.064-5.828 8.332-1.151z"}
                     ]
        };
    }

    function renderStars(n) {
        return {
            "tag":"div", "class":"five-stars", "style":"height: 26px;",
            // https://stackoverflow.com/a/10050831
            "children": [...Array(10).keys()].map(function (i) {
                var odd = i%2 === 0;
                return {
                    "tag":"div", "class":"star-box",
                    "style":"width: "+(odd?"12":"14")+"px; height: 26px;",
                    "children":[starSVG(odd,i<n)]
                }
            })
        }
    }

    function showProduct(id) {
        showTab("reviews");
        var reviewsDiv = document.getElementById("reviews");
        while (reviewsDiv.hasChildNodes()) {
            reviewsDiv.removeChild(reviewsDiv.lastChild);
        }
        reviewsDiv.appendChild(render(renderProduct(id)));
        reviewsDiv.appendChild(renderReviewsHeader());
        var reviewsRendered = renderReviews(productsHashMap[id]["reviews"]);
        reviewsRendered.forEach(function (item) {
            reviewsDiv.appendChild(item);
        })
        //reviewsDiv.appendChild(render(renderStars(id)));
    }

    function showTab(key) {
        const tabIds=["products","reviews"];
        tabIds.forEach(function (tabId) {
            var tab = document.getElementById(tabId);
            if (tabId === key) {
                tab.classList.remove("d-none");
            } else {
                tab.classList.add("d-none");
            }
        });
        tabIds.forEach(function (tabId) {
            var tabHeader = document.getElementById(tabId+"_tab");
            if (tabId === key) {
                tabHeader.classList.add("tab-active");
            } else {
                tabHeader.classList.remove("tab-active");
            }
        })
    }

    function renderMain_(data) {
        window.data = data;
        buildFilters();
        const fieldsOrder = {
            "Users": ["id", "first_name", "last_name", "phone", "email"],
            "Posts": ["id", "userId", "title", "body"],
        };
        const columnSizes = {
            "id": [1, 1],
            "first_name": [5, 2],
            "last_name": [6, 2],
            "phone": [12, 2],
            "email": [12, 4],
            "posts": [12, 1]
        };
        const captionTitles = {
            "id": ["ID", false, ""],
            "first_name": ["First name", true, ""],
            "last_name": ["Last name", true, ""],
            "phone": ["Phone", false, " d-none d-lg-block"],
            "email": ["E-mail", false, " d-none d-lg-block"],
            "posts": ["", false, " d-none d-lg-block"]
        };
        const column = function (item, f, additionalClass = x=>"") {
            return function (field) {
                return {
                    "tag": "div",
                    "class": ("col-" + columnSizes[field][0] +
                        " col-lg-" + columnSizes[field][1]
                        + (additionalClass(field) === "" ? "" :
                            " " + additionalClass(field))
                    ),
                    0: [f(item, field)]
                }
            };
        };
        const fieldsOrderWithPosts = fieldsOrder["Users"].concat(["posts"]);
        var caption = {
            "tag": "div", "class": "row",
            0: fieldsOrderWithPosts.map(column(
                null, (item, field) => captionTitles[field][0],
                field => "fw-bold" + captionTitles[field][2]))
        };
        var filters = {
            "tag": "div", "class": "row",
            0: fieldsOrderWithPosts.map(column(
                null, (item, field) => !captionTitles[field][1] ? "" : {
                    "tag": "input", "type": "text", "name": field,
                    "style": "width:100%;"//todo:class
                }))
        };
        //console.log(caption);
        var dataMapped = Object.values(data).map(function (item) {
            var fields = fieldsOrderWithPosts.map(
                column(item, function (item, field) {
                    return field !== "posts" ? item[field].toString() :
                        {
                            "tag": "a", "href": "javascript:showPosts(" + item["id"] + ");",
                            0: ["Posts"]
                        };
                })
            );
            var posts = Object.values(item["Posts"]).map(function (post) {
                const fAndAddClassByField = {
                    "title": {"f": x => x, "addClass": " fw-bold"},
                    "body": {"f": x => limitByCharsNum(x, 80), "addClass": ""}
                };
                const postDiv = function (post) {
                    return function (field) {
                        var fAndAddClass = fAndAddClassByField[field],
                            addClass = fAndAddClass["addClass"],
                            f = fAndAddClass["f"];
                        return {
                            "tag": "div", "class": "row" + addClass, 0: [
                                {"tag": "div", "class": "col-12", 0: [f(post[field])]}
                            ]
                        }

                    }
                }
                return {
                    "tag": "div", "class": "col-12 col-lg-4 post",
                    0: Object.keys(fAndAddClassByField).map(postDiv(post)),
                    "id": "post_" + post["id"]
                }
            });
            return [
                {"tag": "div", "class": "row", 0: fields, "id": item["id"]},
                {
                    "tag": "div", "class": "row d-none", 0: posts, "id": "posts_" + item["id"],
                    1: [{
                        "tag": "div",
                        "class": "col-12 col-lg-4 align-items-center d-flex justify-content-center",
                        "id": "more_" + item["id"],
                        0: [{
                            "tag": "div", "class": "d-inline-flex",
                            0: [
                                {
                                    "tag": "a", "href": "javascript:morePosts(" + item["id"] + ");",
                                    0: ["More >>>"]
                                }
                            ]
                        }]
                    }]
                }
            ];
        });
        const flatten = function (item, res = []) {
            if (item instanceof Array) {
                item.forEach(elem => flatten(elem, res));
            } else {
                res.push(item);
            }
            return res;
        }
        document.getElementsByTagName("body")[0].appendChild(
            render(
                {
                    "tag": "div", "class": "container", 0: //[{"tag": "p", 0: ["test"]}]
                        [caption, filters], 1: flatten(dataMapped)
                }
            )
        );
        //https://stackoverflow.com/a/19324739
        [...document.getElementsByTagName("input")].forEach(input => input.addEventListener(
            //https://stackoverflow.com/a/19405157
            "input", onInput
        ));
    }

    function onInput(event) {
        //console.log(event.target.value,event);
        var field = event.target.name;
        var value = event.target.value;
        Object.keys(data).forEach(function (id) {
            var item = data[id];
            filters[id][field] = item[field].toLowerCase().includes(value.toLowerCase());
            if (Object.values(filters[id]).every(x => x)) {
                //https://stackoverflow.com/a/196038
                document.getElementById(id).classList.remove("d-none");
            } else {
                document.getElementById(id).classList.add("d-none");
            }
        });
    }

    var filters = {};

    function buildFilters() {
        Object.keys(data).forEach(function (id) {
            //var item = data[id];
            filters[id] = {"first_name": true, "last_name": true};
        });
    }

    function showPosts(id) {
        //console.log(id);
        showPostsNum({
            "id": id, "display": 5,
            "show": {"text": "Hide", "href": "hidePosts"},
            "more": {"text": "More >>>", "href": "morePosts"}
        });
    }

    function morePosts(id) {
        //console.log(id);
        showPostsNum({
            "id": id, "display": "all",
            "show": {"text": "Hide", "href": "hidePosts"},
            "more": {"text": "Less <<<", "href": "showPosts"}
        });
    }

    function hidePosts(id) {
        //console.log(id);
        showPostsNum({
            "id": id, "display": 0,
            "show": {"text": "Posts", "href": "showPosts"},
            "more": {"text": "More >>>", "href": "morePosts"}
        });
    }

    function showPostsNum(how) {
        const last = x => x[x.length - 1];
        var userDiv = document.getElementById(how.id),
            postsDiv = document.getElementById("posts_" + how.id),
            showPostsA = last(userDiv.children).children[0],
            morePostsDiv = document.getElementById("more_" + how.id),
            morePostsA = morePostsDiv.children[0].children[0];
        if (how.display === "all") {
            how.display = postsDiv.children.length;
        }
        [...postsDiv.children].forEach(function (item, index) {
            if (index < how.display) {
                item.classList.remove("d-none");
            } else {
                item.classList.add("d-none");
            }
        });
        morePostsDiv.classList.remove("d-none");
        const aHrefs = {"show": showPostsA, "more": morePostsA};
        Object.keys(aHrefs).forEach(function (key) {
            var item = aHrefs[key];
            item.setAttribute("href", "javascript:" + how[key]["href"] + "(" + how.id + ");");
            item.innerText = how[key]["text"];
        })
        if (how.display === 0) {
            postsDiv.classList.add("d-none");
        } else {
            postsDiv.classList.remove("d-none");
        }
    }

    function limitByCharsNum(s, n, append = "…") {
        //https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/split#splitting_with_a_regexp_to_include_parts_of_the_separator_in_the_result
        var charsCount = 0;
        var res = [];
        var stop = false;
        s.split(/(\s+)/).forEach(function (item) {
            if (stop) {
                return;
            }
            if (charsCount + (item.length) > n) {
                stop = true;
                return;
            }
            res.push(item);
            charsCount += item.length;
        })
        if (stop) {
            res.push(append);
        }
        return res.join("");
    }

    function render(data) {
        //console.log(data,typeof data);
        if (data instanceof Array) {
            return data.map(render);
        }
        if ((typeof data === "string") || (data instanceof String)) { //https://stackoverflow.com/a/9436948
            return document.createTextNode(data);
        }
        if (data instanceof Object) {
            var tag = data["tag"];
            var res;
            if (data["xmlns"] === undefined) {
                res = document.createElement(tag);
            } else {
                res = document.createElementNS(data["xmlns"],tag);
            }
            Object.keys(data).forEach(function (key) {
                if (key === "tag") {
                    return true;
                }
                var item = data[key];
                if ((typeof item === "string") || (item instanceof String)) {
                    res.setAttribute(key, item);
                }
                if (item instanceof Array) {
                    var children = render(item);
                    //console.log(children);
                    children.forEach(function (child) {
                        res.appendChild(child);
                    });
                }
            })
            return res;
        }
    }

    //http://xahlee.info/js/js_scritping_svg_basics.html
    if (window.addEventListener) {
        window.addEventListener('load', onLoad, false);
    } else { // IE
        window.attachEvent('onload', onLoad);
    }
    </script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <style>
        .post_title {
            border-top: 1px solid #888;
            border-left: 1px solid #888;
            border-right: 1px solid #888;
        }

        .post_body {
            border-bottom: 1px solid #888;
            border-left: 1px solid #888;
            border-right: 1px solid #888;
        }

        .post {
            border: 1px solid #888;
            border-radius: 5px;
        }

        #tabs ul {
            list-style-type: none;
            padding:0;
            margin:0;
        }
        /*#tabs ul li {
            border: 1px solid gray;
            border-bottom: none;
        }
        #tabs ul li.no-border {
            border: none;
        }*/
        body {
            margin:0;
            padding:0;
        }
        #container {
            margin: 8px 8px 8px 8px;
        }
        #products, #reviews {
            padding: 8px 8px 8px 8px;
        }
        ._40x40 {
            max-height: 40px;
            max-width: 40px;
        }
        .overflow-hidden {
            overflow: hidden;
        }
        /* the entire svg and styles were taken as is from movielens.org */
        .star-box {
            display: inline-block;
            overflow: hidden;
        }
        .star-shape.rated {
            fill: #f06624;
        }
        .star-shape {
            fill: #bbb;
            stroke: #808080;
        }
        .five-stars {
            cursor: pointer;
        }
        /* movielens styles end */
        .tab-header {
            cursor: pointer;
        }
        .tab-active {
            background-color: #dee2e6;/* https://getbootstrap.com/docs/5.0/utilities/background/#variables $gray-300*/
        }
        #reviews_header {
            margin-top: 8px;
        }
    </style>
</head>
<body>
<div id="container">
    <div id="tabs">
        <ul class="row">
            <li id="products_tab"
                class="text-center border border-bottom-0 col-lg-2 col-5 rounded-top tab-header tab-active">Products</li>
            <li id="reviews_tab"
                class="text-center border border-bottom-0 col-lg-2 col-5 rounded-top tab-header">Reviews</li>
            <li class="d-none d-lg-block col-0 col-lg-6"></li>
            <li class="text-center border border-bottom-0 col-1 rounded-top">RU</li>
            <li class="text-center border border-bottom-0 col-1 rounded-top">EN</li>
        </ul>
    </div>
    <div id="products" class="border-top"></div>
    <div id="reviews" class="border-top d-none"></div>
</div>
</body>
</html>